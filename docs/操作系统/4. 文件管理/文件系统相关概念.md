# 文件系统相关概念

## 文件概念



## 🧁文件控制块

为了便于操作系统管理文件，引入**文件控制块FCB**这种数据结构

### FCB中存放文件属性（元数据）

- **名称**：文件名称唯一，以容易的形式保存
- **类型**：被支持不同类型的文件系统所使用
- **创建者**：文件创建者的ID
- **所有者**：文件当前所有者的ID
- **位置**：指向设备和设备文件上的指针
- **大小**：文件当前的大小（以字或者块来表示），也可包含文件允许的最大值
- **保护**：对文件进行保护的访问控制信息
- **创建时间**：最后一次修改和最后一次存取时间。
- **etc**..

## 🥝文件控制块

> 文件控制块(FCB)是用来存放文件需要的各种信息的数据结构，以实现**“`按名存取`”**，FCB的有序结合称为文件目录，一个FCB就是一个文件目录项；当创建一个新文件，系统将分配一个FCB并存放在文件目录当中，称这个FCB为一个**目录项**。

![](https://skywalkerch-1303839378.cos.ap-nanjing.myqcloud.com/mypicbed202307081443733.svg)

## 🍓索引结点

由于在查找文件时仅使用到了**文件名**，因此FCB中其他信息对于查找时没用，而磁盘块的大小有限，一个FCB中存在大量对查找无用的信息，因此当文件目录存在磁盘块中，其实浪费了大部分的空间。比如一个FCB大小64B，一个磁盘块大小1kB，所以一个磁盘块中只能存放16个连续的FCB目录项；现在将FCB除去**文件名**以外的其他信息放在一个叫**索引节点(index node)**，也称i结点的数据结构，然后文件目录项由文件名和指向索引结点的指针构成，这样能大大减小一个文件目录项的大小，因而可以提高一磁盘块可存放的文件目录项的数量，从而在查找文件时可以减少访问磁盘的次数。

![](https://skywalkerch-1303839378.cos.ap-nanjing.myqcloud.com/mypicbed202307081459122.svg)

### 磁盘索引结点

> 指存放在磁盘上的索引结点，每个文件有且仅有一个唯一的磁盘索引结点，磁盘索引结点包含的主要内容如上图所示。

### 内存索引结点

> 指存放在内存的索引结点，将磁盘索引结点复制到内存的索引点中，便于之后使用，另外内存索引结点的内容还增加了以下内容：
>
> - **索引结点状态编号**：用于表示内存索引结点
> - **状态**：指示i结点是否上锁或被修改
> - **访问计数**：有进程访问此i结点 计数+1，否则-1
> - **逻辑设备号**：文件所属文件系统的逻辑设备号
> - **链接指针**：作用是将多个内存索引结点连接在一起，形成一个链表，以便于在内存中快速查找和访问数据。

## 🍉文件操作

### 基本操作

1. **创建文件**：一、为新文件分配必要的外存空间；二、在目录中为其创建一个目录项FCB
2. **写文件**：执行一个系统调用，对于给定文件名，搜索目录以查找文件位置，并且系统必须为该文件维护一个写位置指针，每当写操作发生，更新写位置指针。
3. **读文件**：为了读文件，执行read系统调用，搜索目录以查找相关目录项，系统维护一个读位置指针，每当读操作发生就更新读位置指针。
4. **重新定位文件**：即文件定位，搜索目录以找到适当的条目，并将当前文件位置指针重定位到给定值，不涉及读/写文件。例如C语言中fseek函数的参数:

>| 常量     | 描述               |
>| -------- | ------------------ |
>| SEEK_SET | 文件的开头         |
>| SEEK_CUR | 文件指针的当前位置 |
>| SEEK_END | 文件的末尾         |

5. **删除文件**：先从目录中检索指定文件名的目录项，然后释放该文件所占的存储空间，并删除对应的文件目录项FCB
6. **截断文件**：允许文件所有属性不变，并删除文件内容，将其长度置为0并释放其空间。

### **文件打开与关闭**

> 为了避免多次重复地检索目录，大多数操作系统要求，在文件使用前通过系统调用open被显式的打开。

- **open系统调用**：根据文件名搜索到目录项，将指明文件的属性（包括文件的物理位置），从外村复制到内存打开文件表的一个条目中，并返回一个文件描述符fd送给用户，指向这个条目。
- **close系统调用**：操作系统将会从系统打开文件表中删除这个条目。

![](https://skywalkerch-1303839378.cos.ap-nanjing.myqcloud.com/mypicbed202307081543281.svg)

## 🍭文件保护

> 为了防止文件共享可能会导致文件被破坏或未经核准用户修改文件,文件系统必须控制用户对文件的存取,解决文件的读、写、执行的控制问题。

### 口令防护

口令指用户在建立一个文件时提供一个口令，系统为其建立的FCB上附上该口令，同时告诉允许共享该文件的用户。用户请求访问文件需要提供口令。

优点：

- 时间，空间开销不多

缺点：

- 口令直接存在系统内部，不安全。

### 加密防护

指用户对文件加密，文件被访问需要提供密钥，然后用此密钥对文件进行解码。

优点:

- 方法安全性高但是

缺点：

- 解码过程开销比较大。

### 访问控制

根据用户身份进行控制。实现基于身份访问的最为普通的方法是，为每个文件和目录增加一个**访问控制列表（Access-Control-List ACL）**，依规定每个用户名及其所允许访问的类型。

优点:

- 可以使用复杂的访问方法

缺点：

- 长度无法预计并可能导致复杂的空间管理，可用精简的访问列表



精简访问列表拥有三种用户类型：

- **拥有者**：创建文件的用户
- **组**：一组需要共享文件且具有类型访问的用户
- **其他**：系统其他用户

![](https://skywalkerch-1303839378.cos.ap-nanjing.myqcloud.com/mypicbed202307081602645.png)

> 例如有2个用户user1 ,user2 ，权限类型分为 **完全控制** **读** **写** **执行** 四种
>
> ![](https://skywalkerch-1303839378.cos.ap-nanjing.myqcloud.com/mypicbed202307081604759.svg)
>
> 那么就应该用
> $$
> 8=2 \times 4
> $$
> 8个bit来控制权限。

### 注意

- 现代操作系统常用文件保护方法是，将访问控制列表与用户、组、其他成员访问控制列表结合起来使用
- 对于多级目录而言，不仅需要保护单个目录，还应当保护子目录内的文件，即需要提供目录保护机制。



